// Main application entry point with enhanced features\n\nimport { CONFIG, RateLimiter } from './config.js';\nimport { sanitizeInput, sanitizeObject } from './sanitizer.js';\nimport { login, logout, checkAuth, getProfile } from './auth.js';\nimport { makeRequest } from './api.js';\nimport { \n    themeManager, \n    toastManager, \n    skeletonLoader, \n    lazyLoader \n} from './ui-enhanced.js';\nimport { FormValidator, SubmitButtonHandler } from './validation-enhanced.js';\n\n/**\n * Main Application Class\n */\nclass SchemeAssistApp {\n    constructor() {\n        this.currentSection = 'home';\n        this.user = null;\n        this.recommendations = [];\n        this.formValidator = null;\n        this.submitHandler = null;\n        \n        this.init();\n    }\n    \n    async init() {\n        console.log('ðŸš€ Initializing SchemeAssist AI...');\n        \n        // Register service worker for PWA\n        this.registerServiceWorker();\n        \n        // Setup navigation\n        this.setupNavigation();\n        \n        // Setup back to top button\n        this.setupBackToTop();\n        \n        // Setup enhanced form validation\n        this.setupFormValidation();\n        \n        // Setup user authentication\n        await this.setupAuth();\n        \n        // Setup mobile menu\n        this.setupMobileMenu();\n        \n        // Setup search functionality\n        this.setupSearch();\n        \n        // Setup offline detection\n        this.setupOfflineDetection();\n        \n        // Initialize current section\n        this.initializeCurrentSection();\n        \n        console.log('âœ… SchemeAssist AI initialized successfully');\n    }\n    \n    async registerServiceWorker() {\n        if ('serviceWorker' in navigator) {\n            try {\n                const registration = await navigator.serviceWorker.register('/sw.js');\n                console.log('âœ… Service Worker registered:', registration);\n                \n                // Handle updates\n                registration.addEventListener('updatefound', () => {\n                    const newWorker = registration.installing;\n                    if (newWorker) {\n                        newWorker.addEventListener('statechange', () => {\n                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {\n                                toastManager.show(\n                                    'App updated! Please refresh for the latest features.',\n                                    'info',\n                                    0,\n                                    [{\n                                        key: 'refresh',\n                                        label: 'Refresh',\n                                        handler: () => window.location.reload()\n                                    }]\n                                );\n                            }\n                        });\n                    }\n                });\n            } catch (error) {\n                console.error('âŒ Service Worker registration failed:', error);\n            }\n        }\n    }\n    \n    setupNavigation() {\n        const navLinks = document.querySelectorAll('.nav-link');\n        navLinks.forEach(link => {\n            link.addEventListener('click', (e) => {\n                e.preventDefault();\n                const section = link.getAttribute('data-section');\n                this.navigateToSection(section);\n            });\n        });\n        \n        // Handle browser back/forward\n        window.addEventListener('popstate', (e) => {\n            const section = e.state?.section || 'home';\n            this.navigateToSection(section, false);\n        });\n    }\n    \n    navigateToSection(section, pushState = true) {\n        // Hide all sections\n        document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));\n        \n        // Show target section\n        const targetSection = document.getElementById(section);\n        if (targetSection) {\n            targetSection.classList.remove('hidden');\n            \n            // Scroll to section smoothly\n            targetSection.scrollIntoView({ behavior: 'smooth' });\n        }\n        \n        // Update navigation\n        document.querySelectorAll('.nav-link').forEach(link => {\n            link.classList.remove('active');\n            if (link.getAttribute('data-section') === section) {\n                link.classList.add('active');\n            }\n        });\n        \n        // Update URL\n        if (pushState) {\n            history.pushState({ section }, '', `#${section}`);\n        }\n        \n        this.currentSection = section;\n        \n        // Section-specific initialization\n        this.initializeSection(section);\n    }\n    \n    initializeSection(section) {\n        switch (section) {\n            case 'recommend':\n                this.initializeRecommendations();\n                break;\n            case 'alerts':\n                this.initializeAlerts();\n                break;\n            case 'search':\n                this.initializeSearch();\n                break;\n            case 'stats':\n                this.loadStatistics();\n                break;\n        }\n    }\n    \n    setupBackToTop() {\n        const backToTopBtn = document.getElementById('backToTop');\n        if (!backToTopBtn) return;\n        \n        let isVisible = false;\n        \n        window.addEventListener('scroll', () => {\n            const shouldShow = window.pageYOffset > 300;\n            \n            if (shouldShow && !isVisible) {\n                backToTopBtn.style.display = 'flex';\n                requestAnimationFrame(() => {\n                    backToTopBtn.style.opacity = '1';\n                    backToTopBtn.style.transform = 'translateY(0)';\n                });\n                isVisible = true;\n            } else if (!shouldShow && isVisible) {\n                backToTopBtn.style.opacity = '0';\n                backToTopBtn.style.transform = 'translateY(20px)';\n                setTimeout(() => {\n                    if (!isVisible) backToTopBtn.style.display = 'none';\n                }, 300);\n                isVisible = false;\n            }\n        });\n        \n        backToTopBtn.addEventListener('click', () => {\n            window.scrollTo({\n                top: 0,\n                behavior: 'smooth'\n            });\n        });\n    }\n    \n    setupFormValidation() {\n        const profileForm = document.getElementById('profileForm');\n        if (profileForm) {\n            // Add data-validate attribute for auto-initialization\n            profileForm.setAttribute('data-validate', 'true');\n            \n            this.formValidator = new FormValidator(profileForm, {\n                showProgress: true,\n                realTimeValidation: true\n            });\n            \n            const submitBtn = profileForm.querySelector('button[type=\"submit\"]');\n            if (submitBtn) {\n                this.submitHandler = new SubmitButtonHandler(submitBtn, {\n                    loadingText: 'Finding Schemes...',\n                    successText: 'Found Schemes!'\n                });\n            }\n            \n            profileForm.addEventListener('submit', (e) => {\n                e.preventDefault();\n                this.handleRecommendationSubmit(e);\n            });\n        }\n    }\n    \n    async handleRecommendationSubmit(e) {\n        e.preventDefault();\n        \n        if (!this.formValidator.validateForm()) {\n            toastManager.show(\n                'Please fix the errors in the form before submitting.',\n                'warning'\n            );\n            this.formValidator.focusFirstError();\n            return;\n        }\n        \n        const formData = new FormData(e.target);\n        const profileData = {\n            state: sanitizeInput(formData.get('state')),\n            income: parseInt(sanitizeInput(formData.get('income'))),\n            category: sanitizeInput(formData.get('category')),\n            caste_category: sanitizeInput(formData.get('caste_category')),\n            age: parseInt(sanitizeInput(formData.get('age')) || '30'),\n            min_match_score: parseInt(sanitizeInput(formData.get('min_match')) || '95')\n        };\n        \n        try {\n            this.submitHandler.setLoading(true);\n            \n            // Show skeleton loader\n            skeletonLoader.show('resultsSkeleton', 'card', 4);\n            document.getElementById('results').innerHTML = '';\n            \n            const response = await makeRequest('/api/recommend', {\n                method: 'POST',\n                body: sanitizeObject(profileData)\n            });\n            \n            if (response.success) {\n                this.recommendations = response.schemes;\n                this.displayRecommendations(response);\n                this.submitHandler.setSuccess();\n                \n                toastManager.show(\n                    `Found ${response.count} matching schemes!`,\n                    'success'\n                );\n            } else {\n                throw new Error(response.error || 'Failed to get recommendations');\n            }\n            \n        } catch (error) {\n            console.error('Error getting recommendations:', error);\n            this.submitHandler.setError('Failed to find schemes');\n            \n            toastManager.show(\n                error.message || 'Failed to get recommendations. Please try again.',\n                'error'\n            );\n        } finally {\n            skeletonLoader.hide('resultsSkeleton');\n        }\n    }\n    \n    displayRecommendations(data) {\n        const container = document.getElementById('results');\n        if (!container) return;\n        \n        if (!data.schemes || data.schemes.length === 0) {\n            container.innerHTML = `\n                <div class=\"no-results\">\n                    <i class=\"fas fa-search\"></i>\n                    <h3>No schemes found</h3>\n                    <p>Try adjusting your criteria or minimum match percentage.</p>\n                </div>\n            `;\n            return;\n        }\n        \n        const schemesHTML = data.schemes.map(scheme => `\n            <div class=\"scheme-card\" data-scheme=\"${scheme.scheme_name}\">\n                <div class=\"scheme-header\">\n                    <h3>${scheme.scheme_name}</h3>\n                    <div class=\"scheme-score\">\n                        <span class=\"score-badge\">${scheme.eligibility_score}%</span>\n                    </div>\n                </div>\n                \n                <div class=\"scheme-details\">\n                    <div class=\"detail-row\">\n                        <span class=\"label\">Category:</span>\n                        <span class=\"value\">${scheme.category}</span>\n                    </div>\n                    <div class=\"detail-row\">\n                        <span class=\"label\">State:</span>\n                        <span class=\"value\">${scheme.state}</span>\n                    </div>\n                    <div class=\"detail-row\">\n                        <span class=\"label\">Benefit:</span>\n                        <span class=\"value\">${scheme.benefit}</span>\n                    </div>\n                    <div class=\"detail-row\">\n                        <span class=\"label\">Income Range:</span>\n                        <span class=\"value\">â‚¹${scheme.min_income?.toLocaleString()} - â‚¹${scheme.max_income?.toLocaleString()}</span>\n                    </div>\n                </div>\n                \n                <div class=\"scheme-actions\">\n                    <button onclick=\"addToFavorites('${scheme.scheme_name}')\" class=\"btn-secondary\">\n                        <i class=\"fas fa-heart\"></i> Save\n                    </button>\n                    <button onclick=\"viewSchemeDetails('${scheme.scheme_name}')\" class=\"btn-primary\">\n                        <i class=\"fas fa-info-circle\"></i> Details\n                    </button>\n                </div>\n            </div>\n        `).join('');\n        \n        container.innerHTML = `\n            <div class=\"results-summary\">\n                <h3>Found ${data.count} matching schemes</h3>\n                <p>Showing schemes with ${data.min_match_applied}%+ compatibility</p>\n            </div>\n            <div class=\"schemes-grid\">\n                ${schemesHTML}\n            </div>\n        `;\n        \n        // Show export controls\n        const exportControls = document.getElementById('exportControls');\n        if (exportControls) {\n            exportControls.classList.remove('hidden');\n        }\n    }\n    \n    async setupAuth() {\n        try {\n            const isAuthenticated = await checkAuth();\n            \n            if (isAuthenticated) {\n                this.user = await getProfile();\n                this.updateUIForLoggedInUser();\n                this.loadUserProfileAndRecommend();\n            } else {\n                this.updateUIForLoggedOutUser();\n            }\n        } catch (error) {\n            console.error('Auth setup error:', error);\n            this.updateUIForLoggedOutUser();\n        }\n    }\n    \n    updateUIForLoggedInUser() {\n        const userDropdown = document.getElementById('userDropdown');\n        const loginLink = document.getElementById('loginLink');\n        const usernameDisplay = document.getElementById('usernameDisplay');\n        \n        if (userDropdown && loginLink && usernameDisplay) {\n            userDropdown.style.display = 'block';\n            loginLink.style.display = 'none';\n            usernameDisplay.textContent = this.user?.username || 'User';\n        }\n        \n        this.setupUserDropdown();\n    }\n    \n    updateUIForLoggedOutUser() {\n        const userDropdown = document.getElementById('userDropdown');\n        const loginLink = document.getElementById('loginLink');\n        \n        if (userDropdown && loginLink) {\n            userDropdown.style.display = 'none';\n            loginLink.style.display = 'inline-flex';\n        }\n    }\n    \n    setupUserDropdown() {\n        const userBtn = document.getElementById('userBtn');\n        const dropdownMenu = document.getElementById('dropdownMenu');\n        const logoutBtn = document.getElementById('dropdownLogout');\n        \n        if (userBtn && dropdownMenu) {\n            userBtn.addEventListener('click', (e) => {\n                e.stopPropagation();\n                dropdownMenu.classList.toggle('show');\n            });\n            \n            document.addEventListener('click', () => {\n                dropdownMenu.classList.remove('show');\n            });\n        }\n        \n        if (logoutBtn) {\n            logoutBtn.addEventListener('click', async (e) => {\n                e.preventDefault();\n                try {\n                    await logout();\n                    this.user = null;\n                    this.updateUIForLoggedOutUser();\n                    toastManager.show('Logged out successfully!', 'success');\n                } catch (error) {\n                    toastManager.show('Logout failed. Please try again.', 'error');\n                }\n            });\n        }\n    }\n    \n    setupMobileMenu() {\n        const hamburger = document.querySelector('.hamburger');\n        const navMenu = document.querySelector('.nav-menu');\n        \n        if (hamburger && navMenu) {\n            hamburger.addEventListener('click', () => {\n                const isOpen = navMenu.classList.contains('active');\n                \n                navMenu.classList.toggle('active');\n                hamburger.classList.toggle('active');\n                hamburger.setAttribute('aria-expanded', !isOpen);\n                \n                // Prevent body scroll when menu is open\n                document.body.style.overflow = isOpen ? 'auto' : 'hidden';\n            });\n            \n            // Close menu on escape key\n            document.addEventListener('keydown', (e) => {\n                if (e.key === 'Escape' && navMenu.classList.contains('active')) {\n                    navMenu.classList.remove('active');\n                    hamburger.classList.remove('active');\n                    hamburger.setAttribute('aria-expanded', 'false');\n                    document.body.style.overflow = 'auto';\n                    hamburger.focus();\n                }\n            });\n        }\n    }\n    \n    setupSearch() {\n        const searchBtn = document.querySelector('#search button');\n        if (searchBtn) {\n            searchBtn.addEventListener('click', this.performSearch.bind(this));\n        }\n        \n        const searchInput = document.getElementById('searchQuery');\n        if (searchInput) {\n            searchInput.addEventListener('keypress', (e) => {\n                if (e.key === 'Enter') {\n                    this.performSearch();\n                }\n            });\n        }\n    }\n    \n    async performSearch() {\n        const query = sanitizeInput(document.getElementById('searchQuery')?.value || '');\n        const state = sanitizeInput(document.getElementById('searchState')?.value || '');\n        const category = sanitizeInput(document.getElementById('searchCategory')?.value || '');\n        \n        if (!query.trim() && !state && !category) {\n            toastManager.show('Please enter a search query or select filters.', 'warning');\n            return;\n        }\n        \n        try {\n            skeletonLoader.show('searchResults', 'card', 3);\n            \n            const response = await makeRequest('/api/search', {\n                method: 'POST',\n                body: sanitizeObject({\n                    query: query.trim(),\n                    state,\n                    category\n                })\n            });\n            \n            if (response.success) {\n                this.displaySearchResults(response);\n            } else {\n                throw new Error(response.error);\n            }\n            \n        } catch (error) {\n            console.error('Search error:', error);\n            toastManager.show('Search failed. Please try again.', 'error');\n        } finally {\n            skeletonLoader.hide('searchResults');\n        }\n    }\n    \n    setupOfflineDetection() {\n        window.addEventListener('online', () => {\n            toastManager.show('You are back online!', 'success', 3000);\n        });\n        \n        window.addEventListener('offline', () => {\n            toastManager.show(\n                'You are offline. Some features may not work.',\n                'warning',\n                5000\n            );\n        });\n    }\n    \n    initializeCurrentSection() {\n        const hash = window.location.hash.substring(1);\n        const section = hash && document.getElementById(hash) ? hash : 'home';\n        this.navigateToSection(section, false);\n    }\n}\n\n// Global functions for backward compatibility\nwindow.navigateToSection = (section) => {\n    if (window.app) {\n        window.app.navigateToSection(section);\n    }\n};\n\nwindow.addToFavorites = async (schemeName) => {\n    try {\n        const response = await makeRequest('/api/favorites', {\n            method: 'POST',\n            body: { scheme_name: schemeName }\n        });\n        \n        if (response.success) {\n            toastManager.show('Added to favorites!', 'success');\n        }\n    } catch (error) {\n        toastManager.show('Failed to add to favorites.', 'error');\n    }\n};\n\n// Initialize app when DOM is ready\nif (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', () => {\n        window.app = new SchemeAssistApp();\n    });\n} else {\n    window.app = new SchemeAssistApp();\n}\n\nexport { SchemeAssistApp };
